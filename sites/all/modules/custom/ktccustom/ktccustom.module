<?php

/**
 * implementation of hook_menu
 */
function ktccustom_menu() {

    $items['document/%'] = array(
        'title' => 'Document',
        'page callback' => 'ktc_get_document',
        'page arguments' => array(1),
        'access callback' => TRUE,
        'type' => MENU_CALLBACK,
    );

    $items['document-browse'] = array(
        'title' => '',
        'page callback' => 'ktc_document_browse',
        'page arguments' => array(1),
        'access callback' => TRUE,
        'type' => MENU_CALLBACK,
    );
    
    $items['document-browse/%'] = array(
        'title' => '',
        'page callback' => 'ktc_document_browse_category',
        'page arguments' => array(1),
        'access callback' => TRUE,
        'type' => MENU_CALLBACK,
    );
    
    return $items;
}


// gets the file url for the node and sends the user to it
function ktc_get_document($nid) {
    $node = node_load($nid);
    if ($node == NULL) {
        return "There is no document with id " . $nid . ".";
    }
    if (!isset($node->field_document_file['und'])) {
        return "The file associated with this document appears to be missing.";
    }
    $file = file_load($node->field_document_file['und'][0]['fid']);
    //$headers = file_get_content_headers($file);
    //file_transfer($file->uri, $headers);
    $url = file_create_url($file->uri);
    drupal_goto($url);
}


function ktc_document_browse() {
    drupal_add_css(drupal_get_path('module', 'ktccustom') . '/css/ktccustom.css');
    $topics = taxonomy_get_tree(2);
    $audience = taxonomy_get_tree(3);
    $resourcetypes = taxonomy_get_tree(4); 
    //dpm($topics);
    $rend = array(
        'show_results' => FALSE,
        'topics' => $topics,
        'audience' => $audience,
        'resourcetypes' => $resourcetypes,
        '#theme' => 'ktc_documents',
    );
    return $rend;
}


function ktc_document_browse_category($tid) {
    drupal_add_css(drupal_get_path('module', 'ktccustom') . '/css/ktccustom.css');
    $topics = taxonomy_get_tree(2);
    //$audience = taxonomy_get_tree(3);
    $resourcetypes = taxonomy_get_tree(4); 
    //dpm($topics);
    
    $term = taxonomy_term_load($tid);
    $term_name = '';
    if ($term) {
        $term_name = $term->name;
    }
    // get docs that match the criteria
    $docs = views_embed_view('documents_by_category', 'block', $tid);
    
    $rend = array(
        'show_results' => TRUE,
        'topics' => $topics,
        //'audience' => $audience,
        'category_name' => $term_name,
        'resourcetypes' => $resourcetypes,
        'docs' => $docs,
        '#theme' => 'ktc_documents',
    );
    return $rend;
}


function theme_bw_wolf($variables) {
    return 'hello there';
}


function ktccustom_theme() {
  $items = array(
    'ktc_documents' => array(
      'render element' => 'element',
      'path' => drupal_get_path('module', 'ktccustom') . '/tmpl',
      'template' => 'document-browse',
    ),
  );

  return $items;
}

