<?php

/**
 * implementation of hook_menu
 */
function ktccustom_menu() {

    $items['document/%'] = array(
        'title' => 'Document',
        'page callback' => 'ktc_get_document',
        'page arguments' => array(1),
        'access callback' => TRUE,
        'type' => MENU_CALLBACK,
    );

    $items['document-browse'] = array(
        'title' => '',
        'page callback' => 'ktc_document_browse',
        'page arguments' => array(1),
        'access callback' => TRUE,
        'type' => MENU_CALLBACK,
    );
    
    $items['document-browse/%'] = array(
        'title' => '',
        'page callback' => 'ktc_document_browse_category',
        'page arguments' => array(1),
        'access callback' => TRUE,
        'type' => MENU_CALLBACK,
    );
    
    $items['advocacy-login'] = array(
        'title' => 'Advocacy Tools',
        'page callback' => 'ktc_advocacy_login',
        'access callback' => TRUE,
        'type' => MENU_CALLBACK,
    );
    
    return $items;
}


function ktccustom_init() {
    // add some css/js to fancy up some of the node edit pages
    drupal_add_js(drupal_get_path('module', 'ktccustom') . '/js/ktcadmin.js');
    drupal_add_css(drupal_get_path('module', 'ktccustom') . '/css/ktcadmin.css');
}


// create a login modal. ctools modal is able to handle form validation in a modal,
// which would otherwise be time consuming to do from scratch.
function ktc_advocacy_login() {
    ctools_include('ajax');
    ctools_include('modal');
     $form_state = array(
      'ajax' => TRUE,
      'title' => t('Login'),
    );
    $output = ctools_modal_form_wrapper('user_login', $form_state);
    print ajax_render($output);
}



// gets the file url for the node and sends the user to it
function ktc_get_document($nid) {
    $node = node_load($nid);
    if ($node == NULL) {
        return "There is no document with id " . $nid . ".";
    }
    if (!isset($node->field_document_file['und'])) {
        return "The file associated with this document appears to be missing.";
    }
    
    $url = '';
    if (isset($node->field_doc_type['und']) && $node->field_doc_type['und'][0]['tid'] == 25) {  // external url type
        $url = $node->field_doc_external['und'][0]['url'];
    }
    else {  // locally uploaded file
        $file = file_load($node->field_document_file['und'][0]['fid']);
        $url = file_create_url($file->uri);
    }
    drupal_goto($url);
}


function ktc_document_browse() {
    drupal_add_css(drupal_get_path('module', 'ktccustom') . '/css/ktccustom.css');
    $topics = taxonomy_get_tree(2);
    $audience = taxonomy_get_tree(3);
    $resourcetypes = taxonomy_get_tree(4); 
    //dpm($topics);
    $rend = array(
        'show_results' => FALSE,
        'topics' => $topics,
        'audience' => $audience,
        'resourcetypes' => $resourcetypes,
        '#theme' => 'ktc_documents',
    );
    return $rend;
}


function ktc_document_browse_category($tid) {
    drupal_add_css(drupal_get_path('module', 'ktccustom') . '/css/ktccustom.css');
    $topics = taxonomy_get_tree(2);
    //$audience = taxonomy_get_tree(3);
    $resourcetypes = taxonomy_get_tree(4); 
    //dpm($topics);
    
    $term = taxonomy_term_load($tid);
    $term_name = '';
    if ($term) {
        $term_name = $term->name;
    }
    // get docs that match the criteria
    $docs = views_embed_view('documents_by_category', 'block', $tid);
    
    $rend = array(
        'show_results' => TRUE,
        'topics' => $topics,
        //'audience' => $audience,
        'category_name' => $term_name,
        'resourcetypes' => $resourcetypes,
        'docs' => $docs,
        '#theme' => 'ktc_documents',
    );
    return $rend;
}


function theme_bw_wolf($variables) {
    return 'hello there';
}


function ktccustom_theme() {
  $items = array(
    'ktc_documents' => array(
      'render element' => 'element',
      'path' => drupal_get_path('module', 'ktccustom') . '/tmpl',
      'template' => 'document-browse',
    ),
  );

  return $items;
}


function ktccustom_form_alter(&$form, &$form_state, $form_id) {
    // change the login form for the advocacy login
    // i know this changes it for the /user page too, but who cares...
    if ($form_id == 'user_login') {
        $img_path = path_to_theme().'/images/';
        $form['name']['#size'] = 30;
        $form['name']['#title'] = 'User name:';
        $form['pass']['#title'] = 'Password:';
        $form['pass']['#size'] = 30;
        $form['actions']['submit']['#value'] = 'null';
        $form['actions']['submit']['#type'] = 'image_button';
        $form['actions']['submit']['#src'] = $img_path . 'gobutton.png';
    }
}

